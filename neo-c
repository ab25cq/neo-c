#!/usr/bin/env bash

files=()
opts=()
target=""
no_rm_pp=true

expect_target=false
compile_only=false

for arg in "$@"; do
  if [ "$expect_target" = true ]; then
    target="$arg"
    expect_target=false
    continue
  fi

  case "$arg" in
    -E)
      no_rm_pp=false
      ;;
    -o)
      #opts+=("$arg")
      expect_target=true
      ;;
    -c)
      compile_only=true
      #opts+=("$arg")
      ;;
    -*)
      opts+=("$arg")
      ;;
    *)
      files+=("$arg")
      ;;
  esac
done

#base="${1}"
base="${files[0]%.nc}"
shift


ncc ${opts[@]} ${base}.nc

if test $? = 0
then
    if test $compile_only = true
    then
        if test -z "$target"
        then
            target=${base}.o
        fi
        
#        echo clang -c ${opts[@]} -o ${target} ${base}.c 2> ${base}.c.error 
        if clang -c ${opts[@]} -o ${target} ${base}.c 2> ${base}.c.error 
        then
            rm ${base}.c.error
            if test $no_rm_pp = true
            then
                rm ${base}.nc.i
            fi
        else
            cat ${base}.c.error | grep error; exit 3
        fi
    else 
        if test -z "$target"
        then
            target=${base}
        fi
        
#       echo clang ${opts[@]} -o ${target} ${base}.c 2> ${base}.c.error 
        if clang ${opts[@]} -o ${target} ${base}.c 2> ${base}.c.error 
        then
            rm ${base}.c.error
            if test $no_rm_pp = true
            then
                rm ${base}.nc.i
            fi
        else
            cat ${base}.c.error | grep error; exit 3
        fi
    fi
fi    

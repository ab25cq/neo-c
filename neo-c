#!/usr/bin/env bash

CC=clang

files=()
opts=()
target=""
no_rm_pp=true

expect_target=false
compile_only=false
all_object_file=true

for arg in "$@"; do
  if [ "$expect_target" = true ]; then
    target="$arg"
    expect_target=false
    continue
  fi

  case "$arg" in
    -E)
      no_rm_pp=false
      ;;
    -gcc)
      CC=gcc
      ;;
    -o)
      #opts+=("$arg")
      expect_target=true
      ;;
    -c)
      compile_only=true
      #opts+=("$arg")
      ;;
    -*)
      opts+=("$arg")
      ;;
    *.o) 
      files+=("$arg")
      ;;
    *.c)
      files+=("$arg")
      all_object_file=false
      ;;
    *)
      files+=("$arg")
      all_object_file=false
      ;;
  esac
done

#base="${1}"
base="${files[0]%.nc}"

ncc ${opts[@]} ${base}.nc

transpile_ok=$?

if [ "$all_object_file" == true ]
then
    $CC ${opts[@]} -o ${target} ${files[@]}
elif test $transpile_ok = 0
then
    if test $compile_only = true
    then
        if test -z "$target"
        then
            target=${base}.o
        fi
        
        #echo $CC -c ${opts[@]} -o ${target} ${base}.c 2> ${base}.c.error 
        if $CC -c ${opts[@]} -o ${target} ${base}.c 2> ${base}.c.error 
        then
            rm ${base}.c.error
            if test $no_rm_pp = true
            then
                rm ${base}.nc.i
            fi
        else
            cat ${base}.c.error | grep error; exit 3
        fi
    else 
        if test -z "$target"
        then
            target=${base}
        fi
        
        #echo $CC ${opts[@]} -o ${target} ${base}.c 2> ${base}.c.error 
        if $CC ${opts[@]} -o ${target} ${base}.c 2> ${base}.c.error 
        then
            rm ${base}.c.error
            if test $no_rm_pp = true
            then
                rm ${base}.nc.i
            fi
        else
            cat ${base}.c.error | grep error; exit 3
        fi
    fi
fi    
